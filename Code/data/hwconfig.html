<!DOCTYPE html>
<html>
<head>
	<title>Lay-Z-Spa Module | Hardware Config</title>
	<meta charset="utf-8">
	<link rel="icon" type="image/png" sizes="180x180" href="favicon.png">
	<meta name="theme-color" content="#0f4677">
	<!-- <link rel="manifest" href="manifest.json"> -->
	<link rel="stylesheet" href="main.css">
	<meta  name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1">
	<!-- <script src="function.js" type="text/javascript"></script> -->
</head>

<body>
	<div id="site">
		<header>
			
			<form id="darkModeForm">
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                    <span class="slider round"></span>
                </label>
            </form>
			<a href="./"><div id="header"><span>Hardware Config</span><span>Lay-Z-Spa Module</span></div></a>
			<a href="javascript:void(0);" class="topnavicon" onclick="topNav()"></a>
		</header>

		<div class="topnav" id="topnav">
			<a href="./">Home</a>
			<a href="hwconfig.html" class="active">Hardware Config</a>
			<a href="config.html">SPA Config</a>
			<a href="webconfig.html">Web Config</a>
			<a href="wifi.html">Network Config</a>
			<a href="mqtt.html">MQTT Config</a>
			<a href="/dir/">Directory</a>
			<a href="upload.html">File Uploader</a>
			<a href="remove.html">File Remover</a>
			<a href="chkupdatefw.html">Check firmware update</a>
			<a href="/restart/">Restart ESP</a>
			<!-- <a href="javascript:void(0);" class="bgred" onclick="sendCommand('restartEsp')">Restart ESP</a> -->
		</div>

        <!-- PRE2021,
        MIAMI2021,
        MALDIVES2021,
        M54149E,
        M54173,
        M54154,
        M54144,
        M54138,
        M54123 -->
    
		<h2>Hardware:</h2>
		<section onclick="setPins()">
			<p>Select your CIO (pump) model:</p>
			<input type="radio" id="cio_0" name="cio_model" value="0" checked="checked">
			<label for="cio_pre2021">6 wire, pre 2021 (air)</label><br>
			<input type="radio" id="cio_1" name="cio_model" value="1">
			<label for="cio_2021">6 wire, 2021 (air)</label><br>
			<input type="radio" id="cio_2" name="cio_model" value="2">
			<label for="cio_2021hjt">6 wire, 2021 (air+jet)</label><br>
			<input type="radio" id="cio_3" name="cio_model" value="3">
			<label for="cio_54149e">6 wire, 54149E (air)</label><br>
			<input type="radio" id="cio_4" name="cio_model" value="4">
			<label for="cio_54173">4 wire, 54173 (air+jet)</label><br>
			<input type="radio" id="cio_5" name="cio_model" value="5">
			<label for="cio_54154">4 wire, 54154 (air)</label><br>
			<input type="radio" id="cio_6" name="cio_model" value="6">
			<label for="cio_54144">4 wire, 54144 (jet)</label><br>
			<input type="radio" id="cio_7" name="cio_model" value="7">
			<label for="cio_54138">4 wire, 54138 (air+jet)</label><br>
			<input type="radio" id="cio_8" name="cio_model" value="8">
			<label for="cio_54123">4 wire, 54123 (air)</label><br>
		</section>

		<section onclick="setPins()">
			<p>Select your DSP (display) model:
			<span data-text="In theory we should be able to combine any CIO with any DSP. Not tested but really cool if it actually works :-)" class="tooltip left">?</span></p>
			<input type="radio" id="dsp_0" name="dsp_model" value="0" checked="checked">
			<label for="dsp_pre2021">6 wire, pre 2021 (air)</label><br>
			<input type="radio" id="dsp_1" name="dsp_model" value="1">
			<label for="dsp_2021">6 wire, 2021 (air)</label><br>
			<input type="radio" id="dsp_2" name="dsp_model" value="2">
			<label for="dsp_2021hjt">6 wire, 2021 (air+jet)</label><br>
			<input type="radio" id="dsp_3" name="dsp_model" value="3">
			<label for="dsp_54149e">6 wire, 54149E (air)</label><br>

			<input type="radio" id="dsp_4" name="dsp_model" value="4">
			<label for="dsp_54173">4 wire, 54173 (air+jet)</label><br>
			<input type="radio" id="dsp_5" name="dsp_model" value="5">
			<label for="dsp_54154">4 wire, 54154 (air)</label><br>
			<input type="radio" id="dsp_6" name="dsp_model" value="6">
			<label for="dsp_54144">4 wire, 54144 (jet)</label><br>
			<input type="radio" id="dsp_7" name="dsp_model" value="7">
			<label for="dsp_54138">4 wire, 54138 (air+jet)</label><br>
			<input type="radio" id="dsp_8" name="dsp_model" value="8">
			<label for="dsp_54123">4 wire, 54123 (air)</label><br>
		</section>

		<section onclick="setPins()">
			<p>Select your PCB:</p>
			<input type="radio" id="v1" name="pcb" value="v1" checked="checked">
			<label for="v1">V1</label><br>
			<input type="radio" id="v2" name="pcb" value="v2">
			<label for="v2">V2</label><br>
			<input type="radio" id="v2b" name="pcb" value="v2b">
			<label for="v2b">V2B</label>
			<span data-text="Same PCB as V2 but with wires moved to other pins for better compatibility for some pumps" class="tooltip">?</span><br>
			<input type="radio" id="custom" name="pcb" value="custom">
			<label for="custom">Custom</label>
			<span data-text="If using your own board - fill in the pinout below! Leave fields empty if not used." class="tooltip">?</span><br>
		</section>

		<section>
			<p>Pinout <span data-text="D0-D8 as labeled on the ESP, but without the 'D'. The ESP will convert to GPIO numbers." class="tooltip">?</span></p>
		</p>
			<table>
				<tr>
					<td>CIO</td>
					<td>
						data/td/rx<input type="text" id="pin1" maxlength="2" style="width:30px">
						clk/tx<input type="text" id="pin2" maxlength="2" style="width:30px">
						cs/ld<input type="text" id="pin3" maxlength="2" style="width:30px">
					</td>
				</tr>
				<tr>
					<td>DSP</td>
					<td>
						data/td/tx<input type="text" id="pin4" maxlength="2" style="width:30px">
						clk/rx<input type="text" id="pin5" maxlength="2" style="width:30px">
						cs/ld<input type="text" id="pin6" maxlength="2" style="width:30px">
						audio<input type="text" id="pin7" maxlength="2" style="width:30px">
					</td>
				</tr>
			</table>
		</section>
		
		<section>
			<p>Ambient Temperature Sensor <span data-text="Requires a DS18B20 sensor to be connected to the pin labeled 'Sensor Pin'. The sensor will update the 'Ambient Temperature' periodically." class="tooltip above">?</span></p>
			<table>
				<tr>
					<td>Enable <input type="checkbox" id="hasTempSensor" name="hasTempSensor" value="checked"></td>
					<td>Sensor Pin <span data-text="D0-D8 as labeled on the ESP, but without the 'D'. The ESP will convert to GPIO numbers." class="tooltip above">?</span> <input type="text" id="pin8" maxlength="2" style="width:30px"></td>
				</tr>
			</table>
		</section>

		<section>
			<p>Power levels (in Watts) <span data-text="Customize power levels for different running modes." class="tooltip above">?</span></p>
			<table>
				<tr>
					<td colspan="5">Override <input type="checkbox" id="pwr_override" onclick="onOverrideClick()"></td>
				</tr>
				<tr>
					<td>Heat stage 1<input type="text" id="pwr_heater_stage1" maxlength="4" style="width:30px" 
						inputmode="numeric" pattern="[0-9]{1,4}"
						disabled="disabled"></td>
					<td>Heat stage 2<input type="text" id="pwr_heater_stage2" maxlength="4" style="width:30px" 
						inputmode="numeric" pattern="[0-9]{1,4}"
						disabled="disabled"></td>
					<td>Pump <input type="text" id="pwr_pump" maxlength="4" style="width:30px"
						inputmode="numeric" pattern="[0-9]{1,4}"
						disabled="disabled"></td>
					<td>Idle <input type="text" id="pwr_idle" maxlength="4" style="width:30px"
						inputmode="numeric" pattern="[0-9]{1,4}"
						disabled="disabled"></td>
					<td>Air <input type="text" id="pwr_air" maxlength="4" style="width:30px"
						inputmode="numeric" pattern="[0-9]{1,4}"
						disabled="disabled"></td>
					<td>Jets <input type="text" id="pwr_jet" maxlength="4" style="width:30px"
						inputmode="numeric" pattern="[0-9]{1,4}"
						disabled="disabled"></td>
				</tr>
			</table>
		</section>

		<section>
			<table>
				<tr>
					<td colspan="2" style="text-align:center">
						<button id="save" class="button" onclick="saveHardwareConfig()">save</button>
					</td>
				</tr>
			</table>
		</section>

	</div>

<script>
  function topNav() {
    var x = document.getElementById("topnav");
    if (x.className === "topnav") {
      x.className += " responsive";
    } else {
      x.className = "topnav";
    }
  }

  function togglePlainText(id) {
    var x = document.getElementById(id);
    if (x.type === "password") {
      x.type = "text";
    } else {
      x.type = "password";
    }
  }

  function validatePassword(id) {
    var x = document.getElementById(id);
    if (x.value == "<enter password>") {
      alert("Please enter a password to continue.");
      return false;
    }
    return true;
  }

  // Function to update the displayed number
  function updateNumber(opt, parent) {
    var parentElement = parent.parentElement;
    var numDisplay = parentElement.querySelector(".numDisplay");
    var number = parseInt(numDisplay.textContent);
    if (opt == "up") number += 1;
    if (opt == "dn") number -= 1;
    numDisplay.textContent = number;
  }

  function increaseNumber(id) {
    var x = document.getElementById(id);
    var val = Number(x.value);
    var max = x.max;
    if (max > val) {
      val += 1;
      x.value = val;
    }
    var opt = "up";
    updateNumber(opt, x);
  }

  function decreaseNumber(id) {
    var x = document.getElementById(id);
    var val = Number(x.value);
    var min = x.min;
    if (min < val) {
      val -= 1;
      x.value = val;
    }
    var opt = "dn";
    updateNumber(opt, x);
  }

  function buttonConfirm(elem, text = "", timeout = 3, reset = true) {
    var originalText = elem.innerHTML;

    elem.innerHTML = text == "" ? "&check;" : text;
    elem.disabled = true;

    if (reset) {
      setTimeout(function () {
        elem.innerHTML = originalText;
        elem.disabled = false;
      }, timeout * 1000);
    }
  }

</script>
<script>
setPins();	
loadHardwareConfig();

function onOverrideClick()
{
	let checked = document.getElementById("pwr_override").checked;
	[...document.querySelectorAll("input[id^='pwr_']")]
		.forEach((e) => {
			if (e.type !== "checkbox") {
				e.disabled = !checked;
			}
		})
}

function setPins()
{
	var cio = document.querySelector("input[name='cio_model']:checked").value;
	var dsp = document.querySelector("input[name='dsp_model']:checked").value;
	var pcb = document.querySelector("input[name='pcb']:checked").value;
	var p1, p2, p3, p4, p5, p6, p7, p8;
	p8 = null;

	switch(pcb)
	{
		case 'v1':
			if(cio == 0 || cio == 1 || cio == 2 || cio == 3)
			{
				p1 = 7;
				p2 = 2;
				p3 = 1;
			}
			if(cio == 4 || cio == 5 || cio == 6 || cio == 7 || cio == 8)
			{
				p1 = 3;
				p2 = 2;
				p3 = null;
			}
			if(dsp == 0 || dsp == 1 || dsp == 2 || dsp == 3)
			{
				p4 = 5;
				p5 = 4;
				p6 = 3;
				p7 = 6;
			}
			if(dsp == 4 || dsp == 5 || dsp == 6 || dsp == 7 || dsp == 8)
			{
				p4 = 6;
				p5 = 7;
				p6 = null;
				p7 = null;
			}
		break;
		case 'v2':
			if(cio == 0 || cio == 1 || cio == 2 || cio == 3)
			{
				p1 = 1;
				p2 = 2;
				p3 = 3;
			}
			if(cio == 4 || cio == 5 || cio == 6 || cio == 7 || cio == 8)
			{
				p1 = 1;
				p2 = 2;
				p3 = null;
			}
			if(dsp == 0 || dsp == 1 || dsp == 2 || dsp == 3)
			{
				p4 = 4;
				p5 = 5;
				p6 = 6;
				p7 = 7;
			}
			if(dsp == 4 || dsp == 5 || dsp == 6 || dsp == 7 || dsp == 8)
			{
				p4 = 4;
				p5 = 5;
				p6 = null;
				p7 = null;
			}
		break;
		case 'v2b':
			if(cio == 0 || cio == 1 || cio == 2 || cio == 3)
			{
				p1 = 1;
				p2 = 2;
				p3 = 5;
			}
			if(cio == 4 || cio == 5 || cio == 6 || cio == 7 || cio == 8)
			{
				p1 = 2;
				p2 = 5;
				p3 = null;
			}
			if(dsp == 0 || dsp == 1 || dsp == 2 || dsp == 3)
			{
				p4 = 6;
				p5 = 4;
				p6 = 3;
				p7 = 7;
			}
			if(dsp == 4 || dsp == 5 || dsp == 6 || dsp == 7 || dsp == 8)
			{
				p4 = 4;
				p5 = 3;
				p6 = null;
				p7 = null;
			}
		break;
		default:
			return;
			// p1 = '';
			// p2 = '';
			// p3 = '';
			// p4 = '';
			// p5 = '';
			// p6 = '';
			// p7 = '';
		break;
	}
	document.getElementById('pin1').value = p1;
	document.getElementById('pin2').value = p2;
	document.getElementById('pin3').value = p3;
	document.getElementById('pin4').value = p4;
	document.getElementById('pin5').value = p5;
	document.getElementById('pin6').value = p6;
	document.getElementById('pin7').value = p7;
	
	if(document.getElementById('pin8').value === undefined || p8 !== null)
	{
		document.getElementById('pin8').value = p8;
	}
}

function loadHardwareConfig()
{
	console.log("requesting hardware settings");
	var req = new XMLHttpRequest();
	req.open('POST', '/gethardware/');
	req.send();
	req.onreadystatechange = function()
	{
		if (this.readyState == 4 && this.status == 200)
		{
			var json = JSON.parse(req.responseText);
			console.log("json message: ");
			console.log(json);
			console.log(json.cio.toString());

			document.getElementById("cio_" + json.cio.toString()).checked = true;
			document.getElementById("dsp_" + json.dsp.toString()).checked = true;
			document.getElementById(json.pcb.toString()).checked = true;
			if(json.hasTempSensor == '1')
			{
				document.getElementById('hasTempSensor').checked = true;
			}
			
			// Set Temperature Sensor Pin from file
			document.getElementById('pin8').value = json.pins[7];
			if(json.pcb == 'custom')
			{
				document.getElementById('pin1').value = json.pins[0];
				document.getElementById('pin2').value = json.pins[1];
				document.getElementById('pin3').value = json.pins[2];
				document.getElementById('pin4').value = json.pins[3];
				document.getElementById('pin5').value = json.pins[4];
				document.getElementById('pin6').value = json.pins[5];
				document.getElementById('pin7').value = json.pins[6];
			}
			else
			{
				setPins();
			}

			// Set power levels if override enabled
			if (json.pwr_levels.override) {
				[...document.querySelectorAll("input[id^='pwr_']")]
				.forEach((e) => {
					if (e.type !== "checkbox") {
						e.value = json.pwr_levels[e.id.slice(4)];
					}
				})
				document.getElementById("pwr_override").checked = true;
				onOverrideClick();
			} else {
				document.getElementById("pwr_override").checked = false;
			}
		}
	}
}

function saveHardwareConfig()
{
	console.log("Sending sethardware request");
	buttonConfirm(document.getElementById('save'), "saved &check; (Don't forget to restart the ESP.)", 6);
	var hasTempSensor = "0";
	if(document.querySelector("input[name='hasTempSensor']").checked)
	{
		hasTempSensor = "1";
	}

	var req = new XMLHttpRequest();
	req.open('POST', '/sethardware/');
	var json = {
		'cio': document.querySelector("input[name='cio_model']:checked").value,
		'dsp': document.querySelector("input[name='dsp_model']:checked").value,
		'pcb': document.querySelector("input[name='pcb']:checked").value,
		'hasTempSensor': hasTempSensor,
		'pins': [
			document.getElementById('pin1').value,
			document.getElementById('pin2').value,
			document.getElementById('pin3').value,
			document.getElementById('pin4').value,
			document.getElementById('pin5').value,
			document.getElementById('pin6').value,
			document.getElementById('pin7').value,
			document.getElementById('pin8').value
		],
		'pwr_levels': 
			[...document.querySelectorAll("input[id^='pwr_']")]
				.reduce((acc, e) => {
					if (e.type === "checkbox") {
						acc[e.id.slice(4)] = e.checked;
					} else {
						acc[e.id.slice(4)] = e.value;
					}
					return acc;
				}, {})
	};
	req.send(JSON.stringify(json));
	console.log(JSON.stringify(json));
}

</script>	

<script src="darkmode.js" type="text/javascript"></script>

</body>
</html>
